#!/bin/bash
WALLPAPER_ROOT="${1:-$HOME/pic/papes}"

# Batch create all thumbnails
imgcache -f "$WALLPAPER_ROOT" > /dev/null

# Find all image files recursively
mapfile -t originPath < <(find "${WALLPAPER_ROOT}" -type f \( -iname "*.png" -o -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.bmp" -o -iname "*.gif" -o -iname "*.webp" \))

if [ ${#originPath[@]} -eq 0 ]; then
    echo "No images found in ${WALLPAPER_ROOT}"
    exit 1
fi

declare -A filename_to_original
declare -A filename_to_cached
strrr=""

# Process each image to get its hash and cached path
for image_path in "${originPath[@]}"; do
    # Get the cached thumbnail path from imgcache
    cached_path=$(imgcache -f "$image_path")
    
    # Extract the filename without extension
    filename=$(basename "$image_path" | sed 's/\.[^.]*$//')
    
    # Store mappings
    filename_to_original["$filename"]="$image_path"
    filename_to_cached["$filename"]="$cached_path"
    
    # Add to rofi menu string with icon
    strrr+="$(echo -n "${filename}\0icon\x1f${cached_path}\n")"
done

# Display rofi menu
selected=$(echo -en "${strrr}" | rofi -dmenu -case-smart -show-icons -p "Choose a wallpaper" -theme-str ' window { height: 800px; } element-icon { size: 80px; } listview { fixed-height: false; }')

if [ -n "$selected" ]; then
    # Get the original full-resolution image path
    full_image_path=$(realpath "${filename_to_original[$selected]}")
    
    # Update hyprpaper config
    cat > ~/.config/hypr/hyprpaper.conf <<CONF
preload = $full_image_path
wallpaper = , $full_image_path
CONF
	# Reload hyprpaper
	pkill hyprpaper
	hyprpaper &
fi
